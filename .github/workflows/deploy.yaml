name: Deploy Kafka on K3s (Lightsail)

on:
  push:
    branches:
      - main

jobs:
  terraform-apply: 
    name: Set up Lightsail Instance
    runs-on: ubuntu-latest
    outputs:
        INSTANCE_IP: ${{ steps.get_instance_ip.outputs.INSTANCE_IP }}
    permissions:
        id-token: write
        contents: read
    env:
        TF_PATH: ./terraform/environments/dev
    steps: 
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
              terraform_version: 1.5.0
              terraform_wrapper: false
        
        - name: Setup AWS Credentials
          uses: aws-actions/configure-aws-credentials@v3
          with:
              role-to-assume: arn:aws:iam::730335465394:role/github_actions_role
              aws-region: ap-southeast-1

        - name: Terraform Initialize
          run: terraform -chdir=${TF_PATH} init 

        - name: Terraform Plan
          run: terraform -chdir=${TF_PATH} plan

        - name: Terraform Apply
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform -chdir=${TF_PATH} apply -auto-approve
        
        - name: Get Instance IP
          id: get_instance_ip
          run: |
            INSTANCE_IP=$(terraform -chdir=${TF_PATH} output -raw instance_ip)
            echo "INSTANCE_IP=$INSTANCE_IP" >> "$GITHUB_OUTPUT"

  helm-deploy:
    name: Helm Deploy
    runs-on: ubuntu-latest
    needs: terraform-apply
    env:
        INSTANCE_IP: ${{ needs.terraform-apply.outputs.INSTANCE_IP }}
    permissions:
        id-token: write
        contents: read
    steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup AWS Credentials
          uses: aws-actions/configure-aws-credentials@v3
          with:
              role-to-assume: arn:aws:iam::730335465394:role/github_actions_role
              aws-region: ap-southeast-1

        - name: Generate Temporary SSH Key
          run: |
            mkdir -p ./tmp
            ssh-keygen -t rsa -b 2048 -f ./tmp/temp_key -q -N ""
            PUBLIC_KEY=$(cat ./tmp/temp_key.pub)
            echo "PUBLIC_KEY=$PUBLIC_KEY" >> "$GITHUB_ENV"

        - name: Add Temporary SSH Key to Lightsail
          run: |
            aws lightsail import-key-pair --key-pair-name github_actions_tmp_key --public-key-base64 "$PUBLIC_KEY"
        
        - name: Install Helm
          run: |
            ssh -i ./tmp/temp_key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP 'bash -s' < ./scripts/install-helm.sh

        - name: Helm Install Kafka
          run: |
            ssh -i ./tmp/temp_key -o StrictHostKeyChecking=no ubuntu@$INSTANCE_IP 'bash -s' < ./scripts/install-kafka.sh

        - name: Remove Temporary SSH Key from Lightsail
          if: always()
          run: |
            aws lightsail delete-key-pair --key-pair-name github_actions_tmp_key