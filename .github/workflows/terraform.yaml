name: Terraform

on:
    push:
        branches:
            - main

    workflow_dispatch:
      inputs:
        environment:
          description: 'Environment to deploy'
          required: true
          default: 'dev'

jobs:
    terraform-apply: 
        name: Terraform Apply
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        env:
            TF_PATH: ./terraform/environments/dev

        steps: 
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.5.0
            
            - name: Setup AWS Credentials
              uses: aws-actions/configure-aws-credentials@v3
              with:
                  role-to-assume: arn:aws:iam::730335465394:role/github_actions_role
                  aws-region: ap-southeast-1

            - name: Terraform Initialize
              run: terraform -chdir=${TF_PATH} init 

            - name: Terraform Plan
              run: terraform -chdir=${TF_PATH} plan

            - name: Terraform Apply
              if: github.ref == 'refs/heads/main' && github.event_name == 'push'
              run: terraform -chdir=${TF_PATH} apply -auto-approve

    terraform-destroy:
        name: Terraform Destroy
        runs-on: ubuntu-latest
        needs: terraform-apply
        permissions:
            id-token: write
            contents: read
        env:
            TF_PATH: ./terraform/environments/${github.event.inputs.environment}

        steps: 
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.5.0
            
            - name: Setup AWS Credentials
              uses: aws-actions/configure-aws-credentials@v3
              with:
                  role-to-assume: arn:aws:iam::730335465394:role/github_actions_role
                  aws-region: ap-southeast-1

            - name: Terraform Initialize
              run: terraform -chdir=${TF_PATH} init 

            - name: Terraform Destroy
              run: terraform -chdir=${TF_PATH} destroy -auto-approve