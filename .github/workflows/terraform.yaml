name: Deploy Kafka on K3s (Lightsail)

on:
  push:
    branches:
      - main

jobs:
  terraform-apply: 
    name: Terraform Apply
    runs-on: ubuntu-latest
    permissions:
        id-token: write
        contents: read
    env:
        TF_PATH: ./terraform/environments/dev

    steps: 
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
              terraform_version: 1.5.0
        
        - name: Setup AWS Credentials
          uses: aws-actions/configure-aws-credentials@v3
          with:
              role-to-assume: arn:aws:iam::730335465394:role/github_actions_role
              aws-region: ap-southeast-1

        - name: Terraform Initialize
          run: terraform -chdir=${TF_PATH} init 

        - name: Terraform Plan
          run: terraform -chdir=${TF_PATH} plan

        - name: Terraform Apply
          if: github.ref == 'refs/heads/main' && github.event_name == 'push'
          run: terraform -chdir=${TF_PATH} apply -auto-approve

  helm-deploy:
    name: Helm Deploy
    runs-on: ubuntu-latest
    needs: terraform-apply
    steps:
        - name: Install Helm and Deploy Kafka
          run: |
            ssh -o StrictHostKeyChecking=no ubuntu@$(terraform output -raw instance_ip) 'bash -s' < ./k3s-setup.sh